{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ post.title }}{% endblock title %}

{% block body %}
<section >
  <div class='container'>
    <div class="row">

      <div class="col-md-12">
        <div class="section">
          {% if messages %}
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <strong>{{ message }}</strong>
          </div>
          {% endfor %}
          {% endif %}

          <div class="thumbnail thumbnail_post_detail">
            <div class="caption">
              <p><a href="{{ post.category.get_absolute_url }}">{{ post.category }}</a></p>
              <h3><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></h3>
              <p><a href="{% url 'profiles:profile_activity' id=post.user.id slug=post.user.profile.slug %}">{{ post.user.username }}</a></p>
              <p>{{ post.content }}</p>
              <p><a href="{{ post.get_absolute_url }}" data-toggle="tooltip" data-placement="top" title="Published {{ post.date_published }}">Edited {{ post.date_edited }}</a></p>
              <p>
                <button type="button" class="btn btn-primary"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> 0</button>
                <button type="button" class="btn btn-link"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> 2</button>

                <button type="button" class="btn btn-link" data-container="body" data-toggle="popover" data-placement="bottom" data-content="Vivamus
                sagittis lacus vel augue laoreet rutrum faucibus."><span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share</button>
                <button type="button" class="btn btn-link" data-container="body" data-toggle="popover" data-placement="bottom" data-content="Vivamus
                sagittis lacus vel augue laoreet rutrum faucibus."><span class="  glyphicon glyphicon-bookmark" aria-hidden="true"></span> Bookmark</button>
              </p>

            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="section">
          <div class="page-header">
            <h4 id="comments_count_title">{{ comments_count }} {{comment_title}}</h4>
          </div>

          {% if no_comments %}
          <div id="no_comments">
            <p>There are no comments.</p>
          </div>
          {% endif %}
          <div class="media" id='comment_form_container'>
            <div class="media-left">
              <a href="#">
                <img class="media-object" src="/media/profile_avatar/1.jpg" alt="..." width="64px" height="64px">
              </a>
            </div>
            <div class="media-body">
              <form method="post" id="comment_form">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  {{ form.non_field_errors }}
                </div>
                {% endif %}

                <div class="form-group" {% if logged_in == False %}data-toggle="modal" data-target="#myModal"{% else %}data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample"{% endif %}>


                  {{ form.content|add_class:"form-control"|attr:"id:comment_form_field"|attr:"placeholder:Leave a comment."|attr:"rows:3" }}
                  {% if form.content.errors %}
                  <div class="alert alert-danger" role="alert">
                    {{ form.content.errors }}
                  </div>
                  {% endif %}
                  {% if form.content.help_text %}
                  <p class="help-block">{{ form.content.help_text|safe }}</p>
                  {% endif %}
                </div>

                {% if logged_in %}
                <div class="collapse" id="collapseExample">
                  <button type="submit"class="btn btn-primary" >{{ comment_button_text }}</button>
                </div>
                {% endif %}
                <!-- Button trigger modal -->


                <!-- Modal -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Login</h4>
                      </div>
                      <div class="modal-body" id="modal_comment_body">
                        <a class="btn btn-default" href="{% url 'login' %}?next={{request.path}}">Login</a>
                      </div>
                      <div class="modal-footer" id="modal_comment_footer">

                        <p>Don't have an account? <a href="{% url 'accounts:register' %}">Register</a></p>

                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>



            {% if no_comments == False %}
            <div id='post_detail_comment_list'>
            {% for comment in current_page %}

            <div class="media">
              <div class="media-left">
                <a href="{% url 'profiles:profile_activity' id=comment.user.id slug=comment.user.profile.slug %}">
                  <img class="media-object" src="{{ comment.user.profile.avatar.url }}" alt="..." width="64px" height="64px">
                </a>
              </div>
              <div class="media-body">
                <a class="media-heading" href="{% url 'profiles:profile_activity' id=comment.user.id slug=comment.user.profile.slug %}">{{ comment.user.username }}</a>
                <p>{{ comment.content}} </p>
                <p>{{ comment.date_created}} </p>
              </div>
            </div>
            {% endfor %}

          </div>
          {% endif %}

          {% if no_comments == False %}
            <div id="post_detail_pag">
            <ul class="pagination">
              {% if current_page.has_previous %}
              <li><a href="?page={{ current_page.previous_page_number }}">&laquo;</a></li>
              {% else %}
              <li class="disabled"><span>&laquo;</span></li>
              {% endif %}
              {% for i in current_page.paginator.page_range %}
              {% if current_page.number == i %}
              <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
              {% else %}
              <li><a href="?page={{ i }}">{{ i }}</a></li>
              {% endif %}
              {% endfor %}
              {% if current_page.has_next %}
              <li><a href="?page={{ current_page.next_page_number }}">&raquo;</a></li>
              {% else %}
              <li class="disabled"><span>&raquo;</span></li>
              {% endif %}
            </ul>
          </div>
          {% endif %}


        </div>
      </div>
    </div>
  </div>

</section>
{% endblock body %}

{% block javascript %}
<script>

var comments_count_title = $("#comments_count_title");
var no_comments = $("#no_comments");
var comment_form_container = $("#comment_form_container");
var comment_form = $("#comment_form");
var comment_form_field = $("#comment_form_field");
var post_detail_comment_list = $("#post_detail_comment_list");
var post_detail_pag = $("#post_detail_pag");

comment_form.submit(function(event){
  event.preventDefault();
  $.ajax({
    type: comment_form.attr('method'),
    url: comment_form.attr('action'),
    data: comment_form.serialize(),
    success:function(data) {
      var comment_list = '<div id="comment_list"><div class="media"><div class="media-left"><a href="'+data.profile_url+'"><img class="media-object" src="'+data.avatar+'" alt="..." width="64px" height="64px"></a></div><div class="media-body"><a class="media-heading" href="'+data.profile_url+'">'+data.username+'</a><p>'+ data.content+'</p><p>'+data.date_created+'</p></div></div></div>';
      var comment = '<div class="media"><div class="media-left"><a href="'+data.profile_url+'"><img class="media-object" src="'+data.avatar+'" alt="..." width="64px" height="64px"></a></div><div class="media-body"><a class="media-heading" href="'+data.profile_url+'">'+data.username+'</a><p>'+ data.content+'</p><p>'+data.date_created+'</p></div></div>';
      var previous_page_number = data.number-1
      var next_page_number = data.number + 1
      var pag = '<div id="pag"><ul id="pag_ul" class="pagination"></ul></div>';
      var pag2 = '<li><a href="?page='+previous_page_number+'">&laquo;</a></li>';
      var pag3 = '<li class="disabled"><span>&laquo;</span></li>';
      var pag6 = '<li><a href="?page='+next_page_number+'">&raquo;</a></li>';
      var pag7 = '<li class="disabled"><span>&raquo;</span></li>';

      comments_count_title.html(data.count + " Comments");
      comment_form_field.val('');

      function paginate() {
        if (data.has_previous) {
          $("#pag_ul").append(pag2);
        }
        else {
          $("#pag_ul").append(pag3);
        }
        for (var x = 1; x < data.page_range+1; x++) {
          if (data.number == x) {
            $("#pag_ul").append('<li class="active"><span>'+x+'<span class="sr-only">(current)</span></span></li>');
          }
          else {
            $("#pag_ul").append('<li><a href="?page='+x+'">'+x+'</a></li>');
          }
        }
        if (data.has_next) {
          $("#pag_ul").append(pag6);
        }
        else {
          $("#pag_ul").append(pag7);
        }
}

      if($('#post_detail_comment_list').length){
        $('#post_detail_comment_list').prepend(comment);
        if($('#post_detail_pag').length){
          $('#post_detail_pag').remove();
          $('#post_detail_comment_list').after(pag);
          paginate();
        }
        else{
          $("#pag").remove();
          $('#post_detail_comment_list').after(pag);
          paginate();
          }
        }

      else{
        if(data.count == 1){
          comment_form_container.after(comment_list);
          $("#comment_list").after(pag);
          paginate();
          no_comments.remove();
        }
        else{
          $("#comment_list").prepend(comment);
          $("#pag").remove();
          $("#comment_list").after(pag);
          paginate();
        }
      }

    },

  });
})
</script>
{% endblock %}
