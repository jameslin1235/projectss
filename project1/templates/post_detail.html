{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ post.title }}{% endblock title %}

{% block body %}
{% include "login_modal.html" %}
<section >
  <div class='container'>
    <div class="row">
      <div class="col-md-12">
        <div class="section">
          <!-- {% if messages %}
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <strong>{{ message }}</strong>
          </div>
          {% endfor %}
          {% endif %} -->

          <div class="thumbnail thumbnail_post_detail">
            <div class="caption">
              <p><a href="{{ post.category.get_absolute_url }}">{{ post.category }}</a></p>
              <h3><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></h3>
              <p><a href="{% url 'profiles:profile_activity' id=post.user.id slug=post.user.profile.slug %}">{{ post.user.username }}</a></p>
              <p>{{ post.content }}</p>
              <p><a href="{{ post.get_absolute_url }}" data-toggle="tooltip" data-placement="top" title="Published {{ post.date_published }}">Edited {{ post.date_edited }}</a></p>
              <p>
                <button type="button" class="btn btn-primary" id="like_button" {% if same_user %}disabled="disabled"{% endif %} data-liked="false"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> {{ post.likes }}</button>
                <button type="button" class="btn btn-link" id="dislike_button" {% if same_user %}disabled="disabled"{% endif %} data-disliked="false"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> {{ post.dislikes }}</button>
                <button type="button" class="btn btn-link" data-container="body" data-toggle="popover" data-placement="bottom" data-content="Vivamus
                sagittis lacus vel augue laoreet rutrum faucibus."><span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share</button>
                <button type="button" class="btn btn-link" id='bookmark_button' ><span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span> Bookmark</button>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="section">
          <div class="page-header" id="post_detail_page_header">
            <h4 id="comments_count">{{ comments_count }} {{comment_title}}</h4>
          </div>

          {% if no_comments %}
          <div id="no_comments">
            <p>There are no comments.</p>
          </div>
          {% endif %}

          <div class="media" id='comment_form_container'>
            <div class="media-left">
              <a href="#">
                <img class="media-object" src="/media/profile_avatar/1.jpg" alt="..." width="64px" height="64px">
              </a>
            </div>
            <div class="media-body">
              <form method="post" id="comment_form" data-pagenum= "1">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  {{ form.non_field_errors }}
                </div>
                {% endif %}

                <!-- Button trigger modal -->
                <div class="form-group" >
                  <textarea class="form-control" id="comment_form_textfield" rows="3" placeholder="Leave a commment." required></textarea>
                  
                  {% if form.content.errors %}
                  <div class="alert alert-danger" role="alert">
                    {{ form.content.errors }}
                  </div>
                  {% endif %}
                  {% if form.content.help_text %}
                  <p class="help-block">{{ form.content.help_text|safe }}</p>
                  {% endif %}
                </div>


                <div class="collapse" id="collapseExample">
                  <button type="submit" class="btn btn-primary" >{{ comment_button_text }}</button>
                </div>



              </form>
            </div>
          </div>

          {% if no_comments == False %}
          <div id='post_detail_comment_list'>
            {% for comment in comments_current_page %}
            <div class="media">
              <div class="media-left">
                <a href="{% url 'profiles:profile_activity' id=comment.user.id slug=comment.user.profile.slug %}">
                  <img class="media-object" src="{{ comment.user.profile.avatar.url }}" alt="..." width="64px" height="64px">
                </a>
              </div>
              <div class="media-body">
                <a class="media-heading" href="{% url 'profiles:profile_activity' id=comment.user.id slug=comment.user.profile.slug %}">{{ comment.user.username }}</a>
                <p>{{ comment.content}} </p>
                <p>{{ comment.date_created}} </p>
              </div>
            </div>
            {% endfor %}
          </div>

          <div id="post_detail_pag">
            <ul id="post_detail_pag_ul" class="pagination">
              {% if comments_current_page.has_previous %}
              <li><a class="page_button" href="?page={{ comments_current_page.previous_page_number }}">&laquo;</a></li>
              {% else %}
              <li class="disabled"><span>&laquo;</span></li>
              {% endif %}
              {% for i in comments_current_page.paginator.page_range %}
              {% if comments_current_page.number == i %}
              <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
              {% else %}
              <li><a class="page_button" href="?page={{ i }}" >{{ i }}</a></li>
              {% endif %}
              {% endfor %}
              {% if comments_current_page.has_next %}
              <li><a class="page_button" href="?page={{ comments_current_page.next_page_number }}">&raquo;</a></li>
              {% else %}
              <li class="disabled"><span>&raquo;</span></li>
              {% endif %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</section>
{% endblock body %}

{% block javascript %}
<script>
var pag1 = '<li class="disabled"><span>&laquo;</span></li>';
var pag2 = '<li class="disabled"><span>&raquo;</span></li>';

function make_post_detail_pag (){
  var post_detail_pag = '<div id="post_detail_pag"><ul id="post_detail_pag_ul" class="pagination"></ul></div>';
  return post_detail_pag;
}

function make_post_detail_page (data, i){
  var post_detail_page = '<div class="media"><div class="media-left"><a href="'+data.list5[i]+'"><img class="media-object" src="'+data.list1[i]+'" alt="..." width="64px" height="64px"></a></div><div class="media-body"><a class="media-heading" href="'+data.list5[i]+'">'+data.list2[i]+'</a><p>'+ data.list3[i]+'</p><p>'+data.list4[i]+'</p></div></div>';
  return post_detail_page;
}

function make_post_detail_comment_list(data){
  var post_detail_comment_list = '<div id="post_detail_comment_list"><div class="media"><div class="media-left"><a href="'+data.profile_url+'"><img class="media-object" src="'+data.avatar+'" alt="..." width="64px" height="64px"></a></div><div class="media-body"><a class="media-heading" href="'+data.profile_url+'">'+data.username+'</a><p>'+ data.content+'</p><p>'+data.date_created+'</p></div></div></div>';
  return post_detail_comment_list;
}

function make_comment(data){
  var comment = '<div class="media"><div class="media-left"><a href="'+data.profile_url+'"><img class="media-object" src="'+data.avatar+'" alt="..." width="64px" height="64px"></a></div><div class="media-body"><a class="media-heading" href="'+data.profile_url+'">'+data.username+'</a><p>'+ data.content+'</p><p>'+data.date_created+'</p></div></div>';
  return comment;
}

function make_post_detail_first_page(element){
  $.ajax({
    url:$(element).attr('action'),
    success:function(data) {
      $("#post_detail_comment_list").remove();
      $("#post_detail_pag").remove();
      $("#comment_form_container").after('<div id="post_detail_comment_list"></div>');
      for (var i = 0; i < data.comment_count; i++) {
        $("#post_detail_comment_list").append(make_post_detail_page(data,i));
      }
      $("#post_detail_comment_list").after(make_post_detail_pag());
      paginate(data);
      $(element).attr("data-pagenum",data.number);
    }})
}

function make_post_detail_any_page(element){
  $.ajax({
    url:$(element).attr("href"),
    success:function(data) {
      $("#post_detail_comment_list").remove();
      $("#post_detail_pag").remove();
      $("#comment_form_container").after('<div id="post_detail_comment_list"></div>');
      for (var i = 0; i < data.comment_count; i++) {
        $("#post_detail_comment_list").append(make_post_detail_page(data,i));
      }
      $("#post_detail_comment_list").after(make_post_detail_pag());
      paginate(data);
      $("#comment_form").attr("data-pagenum",data.number);
    }});
}

function paginate(data) {
  if (data.has_previous) {
    ppn = data.number-1;
    $("#post_detail_pag_ul").append('<li><a class="page_button" href="?page='+ppn+'">&laquo;</a></li>');
  }
  else {
    $("#post_detail_pag_ul").append(pag1);
  }
  for (var x = 1; x < data.page_range+1; x++) {
    if (data.number == x) {
      $("#post_detail_pag_ul").append('<li class="active"><span>'+x+'<span class="sr-only">(current)</span></span></li>');

    }
    else {
      $("#post_detail_pag_ul").append('<li><a class="page_button" href="?page='+x+'">'+x+'</a></li>');
    }
  }
  if (data.has_next) {
    npn = data.number+1;
    $("#post_detail_pag_ul").append('<li><a class="page_button" href="?page='+npn+'">&raquo;</a></li>');
  }
  else {
    $("#post_detail_pag_ul").append(pag2);
  }
}

// Feature 1
$(document).on('click', '#like_button', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("liked")==false){
      $.ajax({
        url:window.location.href + "like",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",true);
        }
      })
    }
    else{
      $.ajax({
        url:window.location.href + "like",
        data:{ unlike: "unlike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",false);

        }
      })
    }

  }
  else{
    $('#myModal').modal()
  }
});

// Feature 2
$(document).on('click', '#dislike_button', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("disliked")==false){
      $.ajax({
        url:window.location.href + "dislike",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",true);
        }
      })
    }
    else{
      $.ajax({
        url:window.location.href + "dislike",
        data:{ undislike: "undislike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",false);
        }
      })
    }
  }
  else{
    $('#myModal').modal()
  }
});

// // Feature 3
// $(document).on('click', '#bookmark_button', function(event) {
//   event.preventDefault();
//   var element = $(this);
//   if ($("#logged_in").attr("data-logged-in")=="True") {
//
//     alert("hello");
//   }
//   else{
//     $('#myModal').modal()
//   }
// });

// Feature 4
$(document).on('click', '#comment_form_textfield', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    $('#collapseExample').collapse('toggle')
  }
  else{
    $('#myModal').modal()
  }
});


// Feature 5
$(document).on('submit', '#comment_form', function(event) {
  event.preventDefault();
  var element = $(this);
  $.ajax({
    type:  $(element).attr('method'),
    url:  $(element).attr('action'),
    data:  $(element).serialize(),
    success:function(data) {
      $("#comments_count").html(data.comments_count + " Comments");
      $("#comment_form_textfield").val("");
      $('#post_detail_page_header').after(make_message(data.message));

      if($('#post_detail_comment_list').length){
        if ($(element).attr("data-pagenum") == 1) {
          $('#post_detail_comment_list').prepend(make_comment(data));
          $('#post_detail_pag').remove();
          $('#post_detail_comment_list').after(make_post_detail_pag());
          paginate(data);
          if (data.comments_count>5) {
            $("#post_detail_comment_list").children().last().remove();
          }
        }
        else{
          make_post_detail_first_page(element);
          }
        }
        else{
          if($(element).attr("data-pagenum") == 1){
            if(data.comments_count == 1){
              $("#comment_form_container").after(make_post_detail_comment_list(data));
              $("#post_detail_comment_list").after(make_post_detail_pag());
              paginate(data);
              $("#no_comments").remove();
            }
            else{
              $("#post_detail_comment_list").prepend(make_comment(data));
              $("#post_detail_pag").remove();
              $("#post_detail_comment_list").after(make_post_detail_pag());
              paginate(data);
            }
            if(data.comments_count>5){
              $("#post_detail_comment_list").children().last().remove();
            }
          }
          else{
            make_post_detail_first_page(element);
            }
          }
        },
      });
    })

    // Feature 6
    $(document).on('click', '.page_button', function() {
      event.preventDefault();
      var element = $(this);
      make_post_detail_any_page(element);
      });
</script>
{% endblock %}
