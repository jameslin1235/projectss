{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ post.title }}{% endblock title %}

{% block body %}
{% include "login_modal.html" %}
<section >
  <div class='container'>
    <div class="row">
      <div class="col-md-12">
        <div class="section">
          <!-- {% if messages %}
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <strong>{{ message }}</strong>
        </div>
        {% endfor %}
        {% endif %} -->

        <div class="thumbnail thumbnail_post_detail">
          <div class="caption">
            <p><a href="{{ post.category.get_absolute_url }}">{{ post.category }}</a></p>
            <h3><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></h3>
            <p><a href="{% url 'profiles:profile_activity' id=post.user.id slug=post.user.profile.slug %}">{{ post.user.username }}</a></p>
            <p>{{ post.content }}</p>
            <p><a href="{{ post.get_absolute_url }}" data-toggle="tooltip" data-placement="top" title="Published {{ post.date_published }}">Edited {{ post.date_edited }}</a></p>
            <p>
              <button type="button" class="btn btn-primary" id="like_button" {% if same_user %}disabled="disabled"{% endif %} data-liked="false"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> {{ post.likes }}</button>
              <button type="button" class="btn btn-link" id="dislike_button" {% if same_user %}disabled="disabled"{% endif %} data-disliked="false"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> {{ post.dislikes }}</button>
              <button type="button" class="btn btn-link" data-container="body" data-toggle="popover" data-placement="bottom" data-content="Vivamus
              sagittis lacus vel augue laoreet rutrum faucibus."><span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share</button>
              <button type="button" class="btn btn-link" id='bookmark_button' ><span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span> Bookmark</button>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      {% include "post_detail_partial.html" %}
    </div>
  </div>
</div>

</section>
{% endblock body %}

{% block javascript %}
<script>

// Feature 1
$(document).on('click', '#like_button', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("liked")==false){
      $.ajax({
        url:window.location.href + "like",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",true);
        }
      })
    }
    else{
      $.ajax({
        url:window.location.href + "like",
        data:{ unlike: "unlike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",false);

        }
      })
    }

  }
  else{
    $('#myModal').modal()
  }
});

// Feature 2
$(document).on('click', '#dislike_button', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("disliked")==false){
      $.ajax({
        url:window.location.href + "dislike",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",true);
        }
      })
    }
    else{
      $.ajax({
        url:window.location.href + "dislike",
        data:{ undislike: "undislike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",false);
        }
      })
    }
  }
  else{
    $('#myModal').modal()
  }
});

    // // Feature 3
    // $(document).on('click', '#bookmark_button', function(event) {
    //   event.preventDefault();
    //   var element = $(this);
    //   if ($("#logged_in").attr("data-logged-in")=="True") {
    //
    //     alert("hello");
    //   }
    //   else{
    //     $('#myModal').modal()
    //   }
    // });

    // Feature 4
    $(document).on('click', '#comment_form_textfield', function(event) {
      event.preventDefault();
      var element = $(this);
      if ($("#logged_in").data("logged-in")== true) {
        $('#collapseExample').collapse('toggle')
      }
      else{
        $('#myModal').modal()
      }
    });


    // Feature 5
    $(document).on('submit', '#comment_form', function(event) {
      event.preventDefault();
      var element = $(this);
      var method = $(element).attr('method');
      var url = $(element).attr('action');
      var pagenum = $(element).parents(".post_detail_page").attr("data-pagenum");
      $.ajax({  // send post request to save comment
        method: method,
        url: url,
        data: {
          content: $("#comment_form_textfield").val(),
          csrfmiddlewaretoken:'{{ csrf_token }}',
        },
        success:function(data) {
          if ($(pagenum) == 1){
            $.ajax({     // send get request to get first page
              url: url,
              success:function(data) {

                $("#post_detail_page_"+pagenum).replaceWith(data);
                $('#post_detail_page_header').after(make_message("Post created."));
              }});
            }
            else{
                $.ajax({     // send get request for the 1st page
                  url: url,
                  success:function(data) {
                    $("#post_detail_page_"+pagenum).replaceWith(data);
                    $('#post_detail_page_header').after(make_message("Post created."));

                  }});
                }
              },
            });
          });


// save comment, give you first page
// if you save, delete current page, send get request for first page and display
// if you click on button, delete current page, send get for other page and display them
// if you post on different page, save result and request first page



        // // Feature 6
        // $(document).on('click', '.page_button', function() {
        //   event.preventDefault();
        //   var element = $(this);
        //   var url = $(element).attr("href");
        //   $.ajax({     // send get request to get nth page
        //     url: url,
        //     success:function(data) {
        //       $('#post_detail_comment_list').remove();
        //       $('#post_detail_pag').remove();
        //       post_detail_comment_list_pag(data);
        //       $("#comment_form").attr("data-pagenum",data.number);
        //     }});
        //   });



          // Feature 6
          $(document).on('click', '.page_button', function() {
            event.preventDefault();
            var element = $(this);
            var url = $(element).attr("href");
            var pagenum = $(element).parents(".post_detail_page").attr("data-pagenum");

            $.ajax({     // send get request to get nth page
              url: url,
              success:function(data) {
                // $("#profile_posts_page_"+pagenum).after('<div id="container"></div>');
                // var content = $('#container').append(data).find(".profile_posts_page");
                // $("#profile_posts_page_"+pagenum).replaceWith(content);
                // $('#container').remove();

                $("#post_detail_page_"+pagenum).replaceWith(data);

              }});
            });
          </script>
          {% endblock %}
