{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ post.title }}{% endblock title %}

{% block body %}



<section >
  <div class='container'>
    <div class="row">
      <div class="col-md-12">
        <div class="section">
          <div class="thumbnail" id="post_container" data-url={{post.get_absolute_url}}>
            <div class="caption">
              <div><a href="{{ post.category.get_absolute_url }}">{{ post.category }}</a></div>
              <div class="post_title_container"><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></div>
              <div class="post_author_container">
                <div class="media">
                  <div class="media-left">
                    <a href="{% url 'profiles:profile_activity' id=post.user.id slug=post.user.profile.slug %}">
                      <img class="media-object profile_avatar" src="{{post.user.profile.avatar.url}}" >
                    </a>
                  </div>
                  <div class="media-body">
                    <h4 class="media-heading"><a href="{% url 'profiles:profile_activity' id=post.user.id slug=post.user.profile.slug %}">{{ post.user.username }}</a></h4>

                  </div>
                </div>
              </div>
              <div class="post_likers_container">
                <button type="button" class="btn btn-link post_likers_button" id="post_likers_button">{{post.likes}} people liked this post.</button>
              </div>
              <div class="post_content_container">{{ post.content }}</div>
              <div class="post_date_container"><a href="{{ post.get_absolute_url }}" data-toggle="tooltip" data-placement="top" title="{{post.date_published}}">Edited {{ post.date_edited }}</a></div>
              <div class="post_buttons_container">
                <button type="button" {% if liked == True %}class="btn btn-primary"{%else%}class="btn btn-link"{% endif %} id="post_like_button" {% if user_status == "self" %}disabled="disabled"{% endif %}><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> <span id="post_likes_count">{{ post.likes }}</span></button>
                <button type="button" {% if disliked == True %}class="btn btn-primary"{%else%}class="btn btn-link"{% endif %} id="post_dislike_button" {% if user_status == "self" %}disabled="disabled"{% endif %}><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> <span id="post_dislikes_count">{{ post.dislikes }}</span></button>
                <button type="button" class="btn btn-link" data-container="body" data-toggle="popover" data-placement="bottom" data-content="Vivamus
                sagittis lacus vel augue laoreet rutrum faucibus."><span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="section">
          {% include "post_detail_page.html" %}
        </div>

      </div>
    </div>
  </div>

</section>

{% endblock body %}

{% block javascript %}
<script>
function get_login_modal(){
  $.ajax({     // ajax GET to get login modal
    url: "/posts/getloginmodal/",
    success:function(data) {
      $("body").append(data);
      $("#login_Modal").modal();
    }});

}


// Feature 2 Close login modal
$(document).on('click', '#login_Modal_close_button', function(event) {
  event.preventDefault();
  var element = $(this);
  $('#login_Modal').modal('hide');
});

// Feature 3 Remove login modal once it is hidden
$(document).on('hidden.bs.modal', '#login_Modal', function(event) {
  event.preventDefault();
  var element = $(this);
  $(element).remove();
});

// Feature 1 Close post likers modal
$(document).on('click', '#post_likers_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents("#post_container").attr("data-url");
  $.ajax({     // ajax GET to get post likers
    url: url + "likers",
    success:function(data) {
      $("body").append(data);
      $("#post_likers_Modal").modal();
    }});
});

// Feature 1 Open post likers modal
$(document).on('click', '#post_likers_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents("#post_container").attr("data-url");
  $.ajax({     // ajax GET to get post likers
    url: url + "likers",
    success:function(data) {
      $("body").append(data);
      $("#post_likers_Modal").modal();
    }});
});

// Feature 2 Close post likers modal
$(document).on('click', '#post_likers_Modal_close_button', function(event) {
  event.preventDefault();
  var element = $(this);
  $('#post_likers_Modal').modal('hide');
});

// Feature 3 Remove modal once it is hidden
$(document).on('hidden.bs.modal', '#post_likers_Modal', function(event) {
  event.preventDefault();
  var element = $(this);
  $(element).remove();
});

// Feature 4 Get more post likers
$(document).on('click', '#post_likers_more_button', function() {
  event.preventDefault();
  var element = $(this);
  var url = $("#post_container").attr("data-url");
  var nextpage = $("#post_likers_more_container").attr("data-nextpage");

  $.ajax({     // ajax GET to get next page of post likers
    url: url + "likers/?page=" + nextpage,
    success:function(data) {
      $("#post_likers_more_container").remove();
      $("#post_likers_modal_body").append(data);
    }});
  });

  // Feature 5 Post likers modal follow buttons
  $(document).on('click','.follow_button',function(){
    event.preventDefault();
    var element = $(this);
    var url= $(element).parents(".profile_container").attr("data-url");
    if ($("#logged_in").data("logged-in")== true) {
      $.ajax({
        url: url + "follow",  // ajax GET to follow/unfollow a profile
        success:function(data) {
          $(element).html(data.message);
          $.ajax({  // ajax GET to get profile followers count
            url: url + "followerscount",
            success:function(data) {
              $(element).parents(".profile_container").find(".profile_followers_count").html(data.profile_followers_count + " Followers");
            }});
        }});
      }
      else{
        get_login_modal();
      }
    });


      // Feature 6 Post likers modal follow buttons mouseenter effect
      $(document).on('mouseenter','.follow_button',function(){
        event.preventDefault();
        var element = $(this);
        if ($("#logged_in").data("logged-in")== true){
          if ($(element).html() == "Followed") {
            $(element).html("Unfollow");
          }
        }
        else{
          event.preventDefault();
        }
      });

      // Feature 7 Post likers modal follow buttons mouseleave effect
      $(document).on('mouseleave','.follow_button',function(){
        event.preventDefault();
        var element = $(this);
        if ($("#logged_in").data("logged-in")== true){
          if ($(element).html() == "Unfollow") {
            $(element).html("Followed");
          }
        }
        else{
          event.preventDefault();
        }
      });


// Feature  Like post
$(document).on('click', '#post_like_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents("#post_container").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    $.ajax({  // ajax GET to like post
      url:url + "like",
      success:function(data) {
        status = data.status;
        if (status == "unliked") {
          $("#post_like_button").attr("class","btn btn-link");
        }
        else{
          $("#post_like_button").attr("class","btn btn-primary");
        }
        $("#post_likes_count").html(data.likes_count);
        $("#post_likers_button").html(data.likes_count+" people liked this post.");

      }
    })
  }
  else{
    $('#myModal').modal()
  }
});

// Feature 2 Dislike post
$(document).on('click', '#post_dislike_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents("#post_container").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    $.ajax({  // ajax GET to dislike post
      url:url + "dislike",
      success:function(data) {
        status = data.status;
        if (status == "undisliked") {
          $("#post_dislike_button").attr("class","btn btn-link");
        }
        else{
          $("#post_dislike_button").attr("class","btn btn-primary");
        }
        $("#post_dislikes_count").html(data.dislikes_count);
      }
    })
  }
  else{
    $('#myModal').modal()
  }
});

// // Feature 2
// $(document).on('click', '#dislike_button', function(event) {
//   event.preventDefault();
//   var element = $(this);
//   if ($("#logged_in").data("logged-in")== true) {
//     if($(element).data("disliked")==false){
//       $.ajax({
//         url:window.location.href + "dislike",
//         success:function(data) {
//           $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
//           $(element).data("disliked",true);
//         }
//       })
//     }
//     else{
//       $.ajax({
//         url:window.location.href + "dislike",
//         data:{ undislike: "undislike" },
//         success:function(data) {
//           $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
//           $(element).data("disliked",false);
//         }
//       })
//     }
//   }
//   else{
//     $('#myModal').modal()
//   }
// });

// Feature 3 Open comment form buttons or modal
$(document).on('click', '#comment_form_textfield', function(event) {
  event.preventDefault();
  var element = $(this);
  if ($("#logged_in").data("logged-in")== true) {
    $("#comment_form_collapse").collapse("show");
  }
  else{
    $('#myModal').modal();
  }
});

// Feature 4 Close comment form buttons
$(document).on('click', '#comment_form_close_button', function(event) {
  event.preventDefault();
  var element = $(this);
  $("#comment_form_collapse").collapse("hide");
});


// Feature 5 Comment form
$(document).on('submit', '#comment_form', function(event) {
  event.preventDefault();
  var element = $(this);
  var method = $(element).attr('method');
  var url = $(element).attr('action');

  $.ajax({  // ajax POST to save comment
    method: method,
    url: url,
    data: {
      content: $("#comment_form_textfield").val(),
      csrfmiddlewaretoken:'{{ csrf_token }}',
    },
    success:function(data) {
      var message = data.message;

      $.ajax({     // ajax GET to get first page
        url: url,
        success:function(data) {
          $("#post_detail_page").replaceWith(data);
          $('#post_detail_page_header').after(make_message(message));
        }});
      },
    });
  });

  // Feature 6 Go to nth page
  $(document).on('click', '.page_button', function() {
    event.preventDefault();
    var element = $(this);
    var url = $(element).attr("href");
    $.ajax({     // ajax GET to get nth page
      url: url,
      success:function(data) {
        $("#post_detail_page").replaceWith(data);
      }});
    });

    </script>
    {% endblock %}
