{% extends "profile_base.html" %}
{% load widget_tweaks %}

{% block title %}{{ user }}'s {{ title }}{% endblock title %}

{% block vertical_nav %}
<ul class="nav nav-pills nav-stacked">
  <li role="presentation"><a id="follow_url" href="{% url 'profiles:profile_activity' id=user.id slug=user.profile.slug  %}" role="tab" >Activity</a></li>
  <li role="presentation" class="active"><a href="{% url 'profiles:profile_posts' id=user.id slug=user.profile.slug  %}" role="tab" >Posts <span id="profile_nav_posts_count">{{posts_count}}</span></a></li>
  {% if is_user %}<li role="presentation"><a href="{% url 'profiles:profile_drafts' id=user.id slug=user.profile.slug  %}" role="tab" >Drafts <span id="profile_nav_drafts_count">{{drafts_count}}</span></a></li>{% endif %}
  <li role="presentation"><a href="{% url 'profiles:profile_comments' id=user.id slug=user.profile.slug  %}" role="tab">Comments</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_bookmarks' id=user.id slug=user.profile.slug  %}" role="tab">Bookmark</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_following' id=user.id slug=user.profile.slug  %}" role="tab">Following</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_followers' id=user.id slug=user.profile.slug  %}" role="tab">Followers</a></li>
</ul>
{% endblock vertical_nav %}

{% block content %}
{% include "login_modal.html" %}
{% include "profile_posts_page.html" %}
{% endblock content %}

{% block javascript %}
<script>

// Feature 1
$(document).on('click', '.like_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents(".thumbnail_container").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("liked")==false){
      $.ajax({
        url:url + "like",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",true);
        }
      })
    }
    else{
      $.ajax({
        url:url + "like",
        data:{ unlike: "unlike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",false);
        }
      })
    }
  }
  else{
    $('#myModal').modal()
  }
});

// Feature 2
$(document).on('click', '.dislike_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents(".thumbnail_container").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("disliked")==false){
      $.ajax({
        url:url + "dislike",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",true);
        }
      })
    }
    else{
      $.ajax({
        url:url + "dislike",
        data:{ undislike: "undislike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",false);
        }
      })
    }

  }
  else{
    $('#myModal').modal()
  }
});

// Feature 3 Open/close comments page
$(document).on('click', '.comment_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_container").attr("data-id");
  var url = $(element).parents(".thumbnail_container").attr("data-url");
  $("#profile_comments_page_"+id).collapse("toggle");
  if ($("#profile_comments_page_"+id).attr("aria-expanded")=="true"){
    $.ajax({     // send ajax get request to get 1st page of paginated comments
      url: url,
      success:function(data) {
        $("#profile_comments_page_"+id).html(data);
      }});
    }
  });

  // Feature 4 Get nth page of paginated comments
  $(document).on('click', '.comments_page_button', function() {
    event.preventDefault();
    var element = $(this);
    var url = $(element).attr("href");
    var id = $(element).parents(".thumbnail_container").attr("data-id");
    $.ajax({     // send ajax get request to get nth page of paginated comments
      url: url,
      success:function(data) {
        $("#profile_comments_page_"+id).html(data);
      }});
    });

    // Feature 6 Open comment form buttons
    $(document).on('click', '.comment_form_textfield', function(event) {
      event.preventDefault();
      var element = $(this);
      var id = $(element).parents(".thumbnail_container").attr("data-id");
      if ($("#logged_in").data("logged-in")== true) {
        $("#comment_form_collapse_"+id).collapse("show");
      }
      else{
        $('#myModal').modal();
      }
    });

    // Feature 7 Close comment form buttons
    $(document).on('click', '.comment_form_close_button', function(event) {
      event.preventDefault();
      var element = $(this);
      var id = $(element).parents(".thumbnail_container").attr("data-id");
      $("#comment_form_collapse_"+id).collapse("hide");
    });

    // Feature 8 Post comment to DB and show first page
    $(document).on('submit', '.comment_form', function(event) {
      event.preventDefault();
      var element = $(this);
      var id = $(element).parents(".thumbnail_container").attr("data-id");
      var url = $(element).parents(".thumbnail_container").attr("data-url");
      var method = $(element).attr('method');
      $.ajax({  // send post request to save comment
        method: method,
        url: url,
        data: {
          content: $("#comment_form_textfield_"+id).val(),
          csrfmiddlewaretoken:'{{ csrf_token }}',
        },
        success:function(data) {
          $.ajax({     // send get request to get first page
            url: url,
            success:function(data) {
              $("#profile_comments_page_"+id).html(data);
              $('#post_detail_page_header_'+id).after(make_message("Comment created."));
              $('#comment_button_'+id).html('<span class="glyphicon glyphicon-comment" aria-hidden="true"></span> '+ $('#comments_count_'+id).html() );
            }});
          },
        });
      });

      // Feature 9 Open delete post modal
      $(document).on('click', '.delete_button', function(event) {
        event.preventDefault();
        var element = $(this);
        var id = $(element).parents(".thumbnail_container").attr("data-id");
        $('#profile_posts_modal_'+id).modal();
      });


      // Feature 10 Delete post and show current page with updated results
      $(document).on('click', '.confirm_delete_button', function(event) {
        event.preventDefault();
        var element = $(this);
        var id = $(element).parents(".thumbnail_container").attr("data-id");
        var url = $(element).parents(".thumbnail_container").attr("data-url");
        var pageurl= $(element).parents("#profile_posts_page").attr("data-pageurl");
        $('#profile_posts_modal_'+id).modal('hide');

        $.ajax({  // send GET request to delete post
          url:url+"delete",
          success:function(data) {
            var message = data.message;
            $.ajax({
              url: pageurl, // send GET request to current url
              success:function(data) {
                $("#profile_posts_page").replaceWith(data);
                $("#profile_nav_posts_count").html($("#profile_posts_count").html());
                $('#profile_posts_page_header').after(make_message(message));
              }});
            }
          })

        });

        // Feature 11 Get nth page of paginated posts
        $(document).on('click', '.profile_posts_page_button', function() {
          event.preventDefault();
          var element = $(this);
          var url = $(element).attr("href");
          var option = $(element).parents("#profile_posts_page").attr("data-option-selected");
          $.ajax({     // send get request to get nth page
            url: url,
            data: {option:option},
            success:function(data) {
              $("#profile_posts_page").replaceWith(data);
              $("#profile_posts_select").val(option);
            }});
          });



          // Feature 12 Filter button
          $(document).on('change','#profile_posts_select',function(){
            event.preventDefault();
            var element = $(this);
            var option = ($(element).val());
            var url= $(element).parents("#profile_posts_page").attr("data-firstpage");

            $.ajax({     // send get request to get nth page
              url: url,
              data: {option:option},
              success:function(data) {
                $("#profile_posts_page").replaceWith(data);
                $("#profile_posts_select").val(option);
              }});
            });

            // Feature 13 Follow/Unfollow button
            $(document).on('click','#follow_button',function(){
              event.preventDefault();
              var element = $(this);
              var url= $("#follow_url").attr("href");
              if ($("#logged_in").data("logged-in")== true) {
                $.ajax({     // send get request to get nth page
                  url: url + "follow",
                  success:function(data) {
                    $(element).html(data.message);
                  }});
              }
              else{
                $('#myModal').modal();
              }
            })

            // Feature 14 Follow/unfollow mouseenter button
            $(document).on('mouseenter','#follow_button',function(){
              event.preventDefault();
              var element = $(this);
              if ($("#logged_in").data("logged-in")== true){
                if ($(element).html() == "Followed") {
                  $(element).html("Unfollow");
                }
              }
              else{
                event.preventDefault();
              }
            });

            // Feature 15 Follow/unfollow mouseleave button
              $(document).on('mouseleave','#follow_button',function(){
                event.preventDefault();
                var element = $(this);
                if ($("#logged_in").data("logged-in")== true){
                  if ($(element).html() == "Unfollow") {
                    $(element).html("Followed");
                  }
                }
                else{
                  event.preventDefault();
                }
            });

          </script>
          {% endblock javascript %}
