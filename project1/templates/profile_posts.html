{% extends "profile_base.html" %}
{% load widget_tweaks %}

{% block title %}{{ user }}'s {{ title }}{% endblock title %}

{% block vertical_nav %}
<ul class="nav nav-pills nav-stacked">
  <li role="presentation"><a href="{% url 'profiles:profile_activity' id=user.id slug=user.profile.slug  %}" role="tab" >Activity</a></li>
  <li role="presentation" class="active"><a href="{% url 'profiles:profile_posts' id=user.id slug=user.profile.slug  %}" role="tab" >Posts {{posts_count}}</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_posts' id=user.id slug=user.profile.slug  %}" role="tab" >Drafts</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_comments' id=user.id slug=user.profile.slug  %}" role="tab">Comments</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_bookmarks' id=user.id slug=user.profile.slug  %}" role="tab">Bookmark</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_following' id=user.id slug=user.profile.slug  %}" role="tab">Following</a></li>
  <li role="presentation"><a href="{% url 'profiles:profile_followers' id=user.id slug=user.profile.slug  %}" role="tab">Followers</a></li>
</ul>
{% endblock vertical_nav %}

{% block content %}
{% include "login_modal.html" %}
{% include "profile_posts_page.html" %}
{% endblock content %}

{% block javascript %}
<script>

// Feature 1
$(document).on('click', '.like_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents(".thumbnail_post_list").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("liked")==false){
      $.ajax({
        url:url + "like",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",true);
        }
      })
    }
    else{
      $.ajax({
        url:url + "like",
        data:{ unlike: "unlike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> ' + data.likes_count);
          $(element).data("liked",false);
        }
      })
    }
  }
  else{
    $('#myModal').modal()
  }
});

// Feature 2
$(document).on('click', '.dislike_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var url = $(element).parents(".thumbnail_post_list").attr("data-url");
  if ($("#logged_in").data("logged-in")== true) {
    if($(element).data("disliked")==false){
      $.ajax({
        url:url + "dislike",
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",true);
        }
      })
    }
    else{
      $.ajax({
        url:url + "dislike",
        data:{ undislike: "undislike" },
        success:function(data) {
          $(element).html('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> ' + data.dislikes_count);
          $(element).data("disliked",false);
        }
      })
    }

  }
  else{
    $('#myModal').modal()
  }
});

// Feature 3 Collapse the selected comments page
$(document).on('click', '.comment_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  var url = $(element).parents(".thumbnail_post_list").attr("data-url");
  $("#profile_comments_page_"+id).collapse("toggle");
  if ($("#profile_comments_page_"+id).attr("aria-expanded")=="true"){
    $.ajax({     // send ajax get request to get 1st page of paginated comments
      url: url,
      success:function(data) {
        $("#profile_comments_page_"+id).html(data);
      }});
  }


});

// Feature 4 Get 1st page of paginated comments
// $(document).on('shown.bs.collapse',".profile_comments_page", function(){
//   var element = $(this);
//   var url = $(element).parents(".thumbnail_post_list").attr("data-url");
//   $.ajax({     // send ajax get request to get 1st page of paginated comments
//     url: url,
//     success:function(data) {
//       $(element).html(data);
//     }});
//   });

// Feature 5 Get nth page of paginated comments
$(document).on('click', '.comments_page_button', function() {
  event.preventDefault();
  var element = $(this);
  var url = $(element).attr("href");
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  $.ajax({     // send ajax get request to get nth page of paginated comments
    url: url,
    success:function(data) {
      $("#profile_comments_page_"+id).html(data);
    }});
  });



// Feature 6 Open comment form buttons
$(document).on('click', '.comment_form_textfield', function(event) {
  event.preventDefault();
  var element = $(this);

  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  if ($("#logged_in").data("logged-in")== true) {
    $("#comment_form_collapse_"+id).collapse("show");
  }
  else{
    $('#myModal').modal();
  }
});

// Feature 7 Close comment form buttons
$(document).on('click', '.comment_form_close_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
    $("#comment_form_collapse_"+id).collapse("hide");
});

// Feature 8
$(document).on('submit', '.comment_form', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  var url = $(element).parents(".thumbnail_post_list").attr("data-url");
  var method = $(element).attr('method');
  var url = url;
  $.ajax({  // send post request to save comment
    method: method,
    url: url,
    data: {
      content: $("#comment_form_textfield_"+id).val(),
      csrfmiddlewaretoken:'{{ csrf_token }}',
    },
    success:function(data) {
        $.ajax({     // send get request to get first page
          url: url,
          success:function(data) {
            $("#post_detail_page_"+id).replaceWith(data);
            $('#post_detail_page_header_'+id).after(make_message("Comment created."));
          }});
          },
        });
      });


$(document).on('click', '.delete_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  $('#profile_posts_modal_'+id).modal();
});



$(document).on('click', '.confirm_delete_button', function(event) {
  event.preventDefault();
  var element = $(this);
  var id = $(element).parents(".thumbnail_post_list").attr("data-id");
  var url = $(element).parents(".thumbnail_post_list").attr("data-url");
  var pageurl= $(element).parents(".profile_posts_page").attr("data-pageurl");
  var pagenum = $(element).parents(".profile_posts_page").attr("data-pagenum");
  $('#profile_posts_modal_'+id).modal('hide');

  $.ajax({  // send GET request to delete post
    url:url + "delete",
    success:function(data) {
      var is_draft = data.is_draft;

      $.ajax({
        url: pageurl, // send GET request to current url
        success:function(data) {
          $("#profile_posts_page_"+pagenum).replaceWith(data);
          if ($(is_draft) == true) {
            $('#profile_posts_page_header').after(make_message("Draft deleted."));
          }
          else{
            $('#profile_posts_page_header').after(make_message("Post deleted."));
          }

        }});
    }
  })

});



      // Feature 7
      $(document).on('click', '.profile_posts_page_button', function() {
        event.preventDefault();
        var element = $(this);
        var url = $(element).attr("href");
        $.ajax({     // send get request to get nth page
          url: url,
          success:function(data) {
            $("#profile_posts_page").replaceWith(data);
          }});
        });
  </script>
  {% endblock javascript %}
